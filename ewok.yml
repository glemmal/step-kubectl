build:
    box:
      id: alpine
      cmd: /bin/sh
    steps:
        - shellcheck

        - script:
            name: install apk packages
            code: apk update && apk add ca-certificates openssh curl python

        - script:
            name: config
            code: |
                GCLOUD_VERSION="253.0.0-linux-x86_64"
                export GCLOUD_DIRNAME="google-cloud-sdk"
                export GCLOUD_SHA="df3834e538025b257b7cc5d6e7518ca16f05e99aa82671dda19045e688b5268a"
                export GCLOUD_FILENAME="${GCLOUD_DIRNAME}-${GCLOUD_VERSION}.tar.gz"
                export GCLOUD_URL="https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/${GCLOUD_FILENAME}"
                export UPX_VERSION="3.93"
                export UPX_SHA="db4ec36b930e7d7e082d93124a59d38fbaedd1c0"
                export UPX_DIRNAME="upx-${UPX_VERSION}-amd64_linux"
                export UPX_FILENAME="${UPX_DIRNAME}.tar.xz"
                export UPX_URL="https://github.com/upx/upx/releases/download/v${UPX_VERSION}/${UPX_FILENAME}"
                echo "Installing version ${GCLOUD_VERSION} of the Google Cloud SDK"
        - script:
            name: fetch upx
            code: |
                curl -L ${UPX_URL} -o ${UPX_FILENAME}

        - script:
            name: validate upx archive
            code: |
                sha1sum ${UPX_FILENAME} | grep -q "${UPX_SHA}"

        - script:
            name: Extract upx archive
            code: |
                tar -xf ${UPX_FILENAME}

        - script:
            name: Fetch gcloud archive
            code: |
                curl -L ${GCLOUD_URL} -o ${GCLOUD_FILENAME}

        - script:
            name: Validate gcloud archive
            code: |
                sha256sum ${GCLOUD_FILENAME} | grep -q "${GCLOUD_SHA}"

        - script:
            name: Extract gcloud archive
            code: |
                tar -xzf ${GCLOUD_FILENAME}

        - script:
            name: Install kubectl gcloud component
            code: |
                yes | ${GCLOUD_DIRNAME}/bin/gcloud components install kubectl

        - script:
            name: Copy gcloud to output dir
            code: |
                cp -r "${GCLOUD_DIRNAME}" ${WERCKER_OUTPUT_DIR}

        - script:
            name: prepare output
            code: |
                cp  "${WERCKER_ROOT}/LICENSE" "${WERCKER_ROOT}/README.md" "${WERCKER_ROOT}/run.sh" "${WERCKER_ROOT}/wercker.yml" "${WERCKER_ROOT}/wercker-step.yml" "$WERCKER_OUTPUT_DIR"
                cd $WERCKER_OUTPUT_DIR
                chmod ugo+rx "$WERCKER_OUTPUT_DIR/${GCLOUD_DIRNAME}/bin/gcloud"
                rm -rf "${GCLOUD_DIRNAME}/platform/gsutil"

        - script:
            name: Compress kubectl
            code: |
                ${UPX_DIRNAME}/upx -1 "$WERCKER_OUTPUT_DIR/${GCLOUD_DIRNAME}/bin/kubectl"

        - script:
            name: Measure output folder
            code: |
                du -csh $WERCKER_OUTPUT_DIR/*
                du -csh $WERCKER_OUTPUT_DIR/${GCLOUD_DIRNAME}/*

test-busybox:
    box:
      id: busybox
      cmd: /bin/sh
    steps:
      - script:
          code: |
              export WERCKER_KUBECTL_COMMAND="version --client"
              export WERCKER_STEP_ROOT=$WERCKER_SOURCE_DIR
              source run.sh

test-alpine:
    box:
      id: alpine
      cmd: /bin/sh
    steps:
      - script:
          code: |
              export WERCKER_KUBECTL_COMMAND="version --client"
              export WERCKER_STEP_ROOT=$WERCKER_SOURCE_DIR
              source run.sh

test-debian:
    box: debian
    steps:
      - script:
          code: |
              export WERCKER_KUBECTL_COMMAND="version --client"
              export WERCKER_STEP_ROOT=$WERCKER_SOURCE_DIR
              source run.sh
